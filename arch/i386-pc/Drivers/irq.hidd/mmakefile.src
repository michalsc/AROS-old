# $Id$
include $(TOP)/config/make.cfg

USER_INCLUDES := -I.

FILES	:=  irq_init functable endtag irq
OBJDIR	:=	$(GENDIR)/$(CURDIR)

#MM Drivers-native : 
Drivers-native : libdefs.h $(foreach f,$(FILES),$(OBJDIR)/$(f).o) irq.s irq_init.s
	%add_objects rom/boot/hidd.kernel.irq
	@ld -r $(foreach f,$(FILES),$(OBJDIR)/$(f).o) \
	    -o $(OSGENDIR)/boot/hidd.kernel.irq.o
	@objcopy -R .note -R .comment $(OSGENDIR)/boot/hidd.kernel.irq.o

#MM
clean ::
	-$(RM) $(OBJDIR) libdefs.h functable.c endtag.c *.err

#MM
setup :
	%mkdirs_q $(OBJDIR)

$(OBJDIR)/%.o : %.S
	%assemble_q

$(OBJDIR)/%.o : %.c
	%compile_q

$(OBJDIR)/%.d : %.c
	%mkdepend_q

irq.s: irq.c
	%ctoasm_q
	
irq_init.s: irq_init.c
	%ctoasm_q
	
libdefs.h : lib.conf
	@$(ECHO) "Generating $@..."
	@$(ARCHTOOL) -c
	
FUNCTABLE_SRCS := $(foreach f,$(FUNCTIONS),$(f).c)
	
functable.c : $(FUNCTABLE_SRCS) $(BINDIR)/scripts/genfunctable.awk \
	libdefs.h
	@$(ECHO) "Generating $@..."
	$(ARCHTOOL) -t

endtag.c :
	@$(ECHO) "Generating $@..."
	@$(ECHO) "#include <libcore/libtail.c>" > $@

%common
%include_deps $(foreach f,$(FILES) $(FUNCTIONS),$(OBJDIR)/$(f).d)
