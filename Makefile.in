# Main makefile for AROS
# Copyright (C) 2000 AROS - The Amiga Research OS
#
# $Id$
default: all

TOP := $(shell pwd)
include $(TOP)/config/make.cfg

all: makedirs tools mmake
	@$(MMAKE) AROS.AROS

makedirs:
	@$(RM) $(TOP)/errors
	@$(FOR) dir in $(AROSDIR) $(GENDIR) $(TOOLDIR) ; do \
	    $(IF) [ ! -d $$dir ]; then \
		$(MECHO) $(MKDIR) "$$dir" ; \
		$(MKDIR) "$$dir" ; \
	    else true ; fi ; \
	done
	@$(IF) [ ! -f $(AROSDIR)/.gdbinit ]; then \
	    $(CP) $(TOP)/_gdbinit $(AROSDIR)/.gdbinit ; \
	else true ; fi

# This file contains user's options.
# Make shouldn't try to generate it if it doesn't exist.
$(TOP)/make.opts:
	@$(NOP)

# Create the tools that are used to build AROS.
tools : $(TOOLLIB) $(GENMF) $(MODTOOL) $(CPAK) $(ARCHTOOL) $(FLEXCAT)

$(TOOLLIB) : $(wildcard $(TOP)/tools/toollib/*.[ch])
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/toollib TOP=$(TOP)

$(GENMF) : $(TOP)/tools/genmf/genmf.c
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/genmf TOP=$(TOP)

$(MODTOOL) : $(TOOLLIB) $(wildcard $(TOP)/tools/modtool/*.[ch])
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/modtool TOP=$(TOP)

$(CPAK) : $(TOP)/tools/cpak/cpak.c
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/cpak TOP=$(TOP)

$(ARCHTOOL) : $(TOP)/tools/archtools/archtool.c
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/archtools TOP=$(TOP)

$(FLEXCAT) : $(TOP)/tools/FlexCat/flexcat.c
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/FlexCat TOP=$(TOP)

# MetaMake apparently requires a slighty different compilation. Probably
# because it is sort-of an external package as well.

mmake : $(TOP)/tools/MetaMake/Makefile $(MMAKE)

$(TOP)/tools/MetaMake/configure : $(TOP)/tools/MetaMake/configure.in
	cd $(TOP)/tools/MetaMake ; autoconf

$(TOP)/tools/MetaMake/Makefile.in : $(TOP)/tools/MetaMake/Makefile.am
	cd $(TOP)/tools/MetaMake ; automake

$(TOP)/tools/MetaMake/Makefile : $(TOP)/tools/MetaMake/configure \
		$(TOP)/tools/MetaMake/Makefile.in
	cd $(TOP)/tools/MetaMake ; ./configure --prefix=$(TOOLDIR)

$(MMAKE): $(TOP)/tools/MetaMake/mmake.c $(GENMF)
	$(MAKE) $(MKARGS) -C $(TOP)/tools/MetaMake
	cp $(TOP)/tools/MetaMake/mmake $(MMAKE)

# Clean the sources
clean:
	@$(MMAKE) AROS.clean

# Clean the sources and tools
arch-clean: clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/MetaMake clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/FlexCat clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/archtools clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/cpak clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/genmf clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/toollib clean

# Really clean all - like a clean checkout
dist-clean: arch-clean
	@$(RM) Makefile configure config.* make.defaults make.opts \
		mmake.cache mmake.config

# Map MetaTargets to make targets : Call mmake with AROS.target
# Standard targets: install docs all-docs
.DEFAULT : mmake
	@$(MMAKE) AROS.$@

# targets which do not generate files or for which a file/directory exists
.PHONY: default all makedirs tools docs clean arch-clean dist-clean \
	install $(TOP)/make.opts

